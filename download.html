<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project Dray</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<style>
/* === CSS LU TETAP, GA DISENTUH === */
body{margin:0;font-family:Poppins;background:#000;color:#fff}
.review-section{margin-top:25px;padding:15px;border-radius:14px;background:rgba(0,0,0,.35)}
.review-item{margin-top:12px;padding:12px;border-radius:14px;background:#0a0a0a}
.review-item .name{font-weight:bold;color:#bfaaff}
.review-item .rating{color:#ffd86b}
</style>
</head>

<body>

<div class="container">

<h1>PROJECT DRAY</h1>

<div class="download-section">
  <h2>üì¶ List Script</h2>
  <div id="download-list">Loading...</div>
</div>

<div class="review-section">
  <div id="reviewList"></div>

  <h3>‚≠ê Beri Ulasan</h3>

  <input id="username" placeholder="Username"><br><br>

  <div id="star-rating">
    <span data-star="1">‚òÖ</span>
    <span data-star="2">‚òÖ</span>
    <span data-star="3">‚òÖ</span>
    <span data-star="4">‚òÖ</span>
    <span data-star="5">‚òÖ</span>
  </div>

  <textarea id="comment" placeholder="Tulis ulasan..."></textarea><br>
  <button id="submitReview">Kirim Ulasan</button>
</div>

</div>

<!-- ================= FIREBASE + LOGIC DIGABUNG ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  query, orderBy, serverTimestamp,
  doc, getDoc, setDoc, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === FIREBASE INIT (SATU KALI) === */
const firebaseConfig = {
  apiKey: "AIzaSyCJnVG8Ln9CmxTmz6tH-ySfbh4G2v-N71A",
  authDomain: "zeno-reviews.firebaseapp.com",
  projectId: "zeno-reviews"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= DOWNLOAD LIST ================= */
const USERNAME = "JAKWIRID";
const REPO = "zeno-downloads";
const FOLDER = "downloads";
const apiURL = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FOLDER}`;
const rawBase = `https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/${FOLDER}/`;

fetch(apiURL)
.then(r => r.json())
.then(files => {
  const list = document.getElementById("download-list");
  list.innerHTML = "";

  files.filter(f=>f.name.endsWith(".zip")).forEach(file=>{
    const div = document.createElement("div");
    div.innerHTML = `
      <div>
        üìÇ ${file.name}
        <div id="count-${file.name}">loading...</div>
      </div>
      <button>‚¨á Download</button>
    `;

    div.querySelector("button").onclick = async ()=>{
      window.open(rawBase + file.name, "_blank");
      const ref = doc(db,"downloads",file.name);
      await setDoc(ref,{count:increment(1)},{merge:true});
      loadCount(file.name);
    };

    list.appendChild(div);
    loadCount(file.name);
  });
});

async function loadCount(name){
  const ref = doc(db,"downloads",name);
  const snap = await getDoc(ref);
  document.getElementById("count-"+name).textContent =
    snap.exists() ? snap.data().count+" downloader" : "0 downloader";
}

/* ================= REVIEW SYSTEM ================= */
let selectedRating = 0;

document.querySelectorAll("#star-rating span").forEach(s=>{
  s.onclick = ()=>{
    selectedRating = s.dataset.star;
    document.querySelectorAll("#star-rating span")
      .forEach(x=>x.style.color = x.dataset.star<=selectedRating?"gold":"#555");
  };
});

document.getElementById("submitReview").onclick = async ()=>{
  const username = usernameInput.value.trim();
  const comment = commentInput.value.trim();
  if(!username || !comment || !selectedRating) return alert("Lengkapi semua");

  await addDoc(collection(db,"reviews"),{
    username, comment,
    rating:selectedRating,
    time:serverTimestamp()
  });

  usernameInput.value="";
  commentInput.value="";
  selectedRating=0;
  loadReviews();
};

async function loadReviews(){
  const list = document.getElementById("reviewList");
  list.innerHTML="‚è≥ Memuat ulasan...";
  const q = query(collection(db,"reviews"),orderBy("time","desc"));
  const snap = await getDocs(q);

  if(snap.empty){ list.innerHTML="Belum ada ulasan."; return; }

  const d = snap.docs[0].data();
  list.innerHTML = `
    <div class="review-item">
      <div class="name">${d.username}</div>
      <div class="rating">${"‚òÖ".repeat(d.rating)}</div>
      <div>${d.comment}</div>
    </div>
  `;
}

loadReviews();
</script>

</body>
</html>
